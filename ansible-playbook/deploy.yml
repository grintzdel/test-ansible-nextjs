- hosts: webserver
  become: yes
  vars:
    app_name: test-ansible-nextjs
    app_dir: /home/mathis.oudin-gcp/test-ansible-nextjs
    app_port: 3001
    repo_url: https://github.com/grintzdel/test-ansible-nextjs.git
    repo_branch: main

  tasks:
    - name: Installer Git si nécessaire
      apt:
        name: git
        state: present
        update_cache: yes

    - name: Vérifier si Node.js est installé
      command: node --version
      register: node_check
      ignore_errors: yes
      changed_when: false

    - name: Vérifier si npm est installé
      command: npm --version
      register: npm_check
      ignore_errors: yes
      changed_when: false

    - name: Afficher les versions installées
      debug:
        msg: "Node.js: {{ node_check.stdout | default('Non installé') }}, npm: {{ npm_check.stdout | default('Non installé') }}"

    - name: Installer Node.js et npm via apt si non installés
      apt:
        name:
          - nodejs
          - npm
        state: present
      when: node_check.rc != 0 or npm_check.rc != 0
      ignore_errors: yes

    - name: Vérifier si le dossier du projet existe
      stat:
        path: "{{ app_dir }}"
      register: project_dir

    - name: Supprimer le dossier existant s'il appartient à root
      file:
        path: "{{ app_dir }}"
        state: absent
      when: project_dir.stat.exists and project_dir.stat.pw_name == 'root'

    - name: Créer le dossier parent si nécessaire
      file:
        path: "/home/mathis.oudin-gcp"
        state: directory
        owner: mathis.oudin-gcp
        group: mathis.oudin-gcp
        mode: '0755'

    - name: Cloner ou mettre à jour le repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_dir }}"
        version: "{{ repo_branch }}"
        force: yes
      become_user: mathis.oudin-gcp

    - name: S'assurer que tous les fichiers appartiennent à mathis.oudin-gcp
      file:
        path: "{{ app_dir }}"
        owner: mathis.oudin-gcp
        group: mathis.oudin-gcp
        recurse: yes

    - name: Vérifier que le dossier existe
      stat:
        path: "{{ app_dir }}"
      register: app_dir_stat

    - name: Afficher le statut du dossier
      debug:
        msg: "Le dossier {{ app_dir }} existe: {{ app_dir_stat.stat.exists }}"

    - name: Installer PM2 globalement
      npm:
        name: pm2
        global: yes
        state: present

    - name: Installer les dépendances du projet
      npm:
        path: "{{ app_dir }}"
        state: present
      become_user: mathis.oudin-gcp

    - name: Générer le build Next.js
      command: npm run build
      args:
        chdir: "{{ app_dir }}"
      become_user: mathis.oudin-gcp

    - name: Arrêter l'application PM2 si elle existe
      command: pm2 delete {{ app_name }}
      become_user: mathis.oudin-gcp
      ignore_errors: yes

    - name: Démarrer l'application avec PM2
      command: pm2 start npm --name "{{ app_name }}" -- start
      args:
        chdir: "{{ app_dir }}"
      environment:
        PORT: "{{ app_port }}"
      become_user: mathis.oudin-gcp

    - name: Sauvegarder la configuration PM2
      command: pm2 save
      become_user: mathis.oudin-gcp

    - name: Configurer PM2 pour démarrer au boot
      command: pm2 startup systemd -u mathis.oudin-gcp --hp /home/mathis.oudin-gcp
      become_user: mathis.oudin-gcp
      ignore_errors: yes

    - name: Vérifier le statut de l'application
      command: pm2 list
      become_user: mathis.oudin-gcp
      register: pm2_status

    - name: Afficher le statut PM2
      debug:
        msg: "{{ pm2_status.stdout_lines }}"
