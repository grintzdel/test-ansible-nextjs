- hosts: serveurs
  become: yes
  vars:
    app_dir: /home/{{ ansible_user }}/my-app
    repo_url: https://github.com/grintzdel/test-ansible-nextjs
    node_version: "20"

  tasks:
    - name: Vérifier la connexion
      ping:

    - name: Installer les dépendances de base
      apt:
        name:
          - curl
          - git
          - ca-certificates
          - gnupg
        state: present
        update_cache: yes

    - name: Télécharger le script d'installation NodeSource
      shell: curl -fsSL https://deb.nodesource.com/setup_{{ node_version }}.x -o /tmp/nodesource_setup.sh
      args:
        creates: /tmp/nodesource_setup.sh

    - name: Exécuter le script NodeSource
      shell: bash /tmp/nodesource_setup.sh
      args:
        creates: /etc/apt/sources.list.d/nodesource.list

    - name: Installer Node.js
      apt:
        name: nodejs
        state: present
        update_cache: yes

    - name: Déployer le code
      shell: |
        set -e
        rm -rf /home/{{ ansible_user }}/my-app
        git clone {{ repo_url }} /home/{{ ansible_user }}/my-app
        chown -R {{ ansible_user }}:{{ ansible_user }} /home/{{ ansible_user }}/my-app

    - name: Installer les dépendances npm
      npm:
        path: "{{ app_dir }}"
        state: present
      become_user: "{{ ansible_user }}"

    - name: Build l'application Next.js
      command: npm run build
      args:
        chdir: "{{ app_dir }}"
      become_user: "{{ ansible_user }}"

    - name: Installer PM2 globalement
      npm:
        name: pm2
        global: yes
        state: present

    - name: Arrêter l'application si elle tourne
      command: pm2 delete my-app
      ignore_errors: yes
      become_user: "{{ ansible_user }}"

    - name: Démarrer l'application avec PM2
      command: pm2 start npm --name "my-app" -- start
      args:
        chdir: "{{ app_dir }}"
      become_user: "{{ ansible_user }}"

    - name: Sauvegarder la configuration PM2
      command: pm2 save
      become_user: "{{ ansible_user }}"

    - name: Configurer PM2 pour démarrer au boot
      command: pm2 startup systemd -u {{ ansible_user }} --hp /home/{{ ansible_user }}
      become_user: "{{ ansible_user }}"
