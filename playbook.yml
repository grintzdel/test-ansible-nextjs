- hosts: serveurs
  become: yes
  vars:
    deploy_user: mathis.oudin-gcp
    app_dir: /home/mathis.oudin-gcp/app

  tasks:
    - name: Installer dépendances système
      apt:
        name: [curl, rsync]
        state: present
        update_cache: yes

    - name: Installer Node.js 20
      shell: curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && apt-get install -y nodejs
      args:
        creates: /usr/bin/node

    - name: Installer PM2
      npm:
        name: pm2
        global: yes

    - name: Créer le répertoire app
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"

    - name: Copier les fichiers
      synchronize:
        src: "{{ playbook_dir }}/"
        dest: "{{ app_dir }}"
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=node_modules"
          - "--exclude=.next"
        delete: yes

    - name: Fixer les permissions
      file:
        path: "{{ app_dir }}"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        recurse: yes

    - name: Build
      shell: |
        npm install
        npm run build
      args:
        chdir: "{{ app_dir }}"
      become_user: "{{ deploy_user }}"

    - name: Start app
      shell: pm2 delete app || true && pm2 start npm --name app -- start && pm2 save
      args:
        chdir: "{{ app_dir }}"
      become_user: "{{ deploy_user }}"
